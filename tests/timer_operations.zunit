#!/usr/bin/env zunit

@setup {
  load _support/bootstrap.zsh
  pomo_test_cleanup
  pomo_mock_time 1000000
}

@teardown {
  pomo_test_cleanup
  pomo_restore_time
}

# Start work tests

@test 'start_work: sets mode to work' {
  _pomo_start_work

  _pomo_read_state
  assert "$POMO_MODE" equals "work"
}

@test 'start_work: sets status to running' {
  _pomo_start_work

  _pomo_read_state
  assert "$POMO_STATUS" equals "running"
}

@test 'start_work: sets correct duration' {
  _pomo_start_work

  _pomo_read_state
  assert "$POMO_DURATION" equals "$POMODORO_WORK_DURATION"
}

@test 'start_work: sets start time' {
  _pomo_start_work

  _pomo_read_state
  assert "$POMO_START_TIME" equals "1000000"
}

@test 'start_work: resets pause state' {
  _pomo_start_work

  _pomo_read_state
  assert "$POMO_PAUSE_TIME" equals "0"
  assert "$POMO_PAUSE_ELAPSED" equals "0"
}

@test 'start_work: outputs confirmation message' {
  run _pomo_start_work
  assert "$output" contains "Started pomodoro work session"
  assert "$output" contains "25:00"
}

# Start break tests

@test 'start_break: sets mode to break' {
  _pomo_start_break

  _pomo_read_state
  assert "$POMO_MODE" equals "break"
}

@test 'start_break: short break sets correct duration' {
  _pomo_start_break "short"

  _pomo_read_state
  assert "$POMO_DURATION" equals "$POMODORO_SHORT_BREAK"
}

@test 'start_break: long break sets correct duration' {
  _pomo_start_break "long"

  _pomo_read_state
  assert "$POMO_DURATION" equals "$POMODORO_LONG_BREAK"
}

@test 'start_break: defaults to short break' {
  _pomo_start_break

  _pomo_read_state
  assert "$POMO_DURATION" equals "$POMODORO_SHORT_BREAK"
}

@test 'start_break: outputs short break message' {
  run _pomo_start_break "short"
  assert "$output" contains "short break"
}

@test 'start_break: outputs long break message' {
  run _pomo_start_break "long"
  assert "$output" contains "long break"
}

# Start timer tests

@test 'start_timer: sets mode to timer' {
  _pomo_start_timer "10m"

  _pomo_read_state
  assert "$POMO_MODE" equals "timer"
}

@test 'start_timer: parses duration correctly' {
  _pomo_start_timer "10m"

  _pomo_read_state
  assert "$POMO_DURATION" equals "600"
}

@test 'start_timer: invalid duration returns error' {
  run _pomo_start_timer "invalid"
  assert $state equals 1
  assert "$output" contains "Invalid duration"
}

@test 'start_timer: outputs confirmation' {
  run _pomo_start_timer "5m"
  assert "$output" contains "Timer started"
  assert "$output" contains "05:00"
}

# Start stopwatch tests

@test 'start_stopwatch: sets mode to stopwatch' {
  _pomo_start_stopwatch

  _pomo_read_state
  assert "$POMO_MODE" equals "stopwatch"
}

@test 'start_stopwatch: sets duration to 0' {
  _pomo_start_stopwatch

  _pomo_read_state
  assert "$POMO_DURATION" equals "0"
}

@test 'start_stopwatch: outputs confirmation' {
  run _pomo_start_stopwatch
  assert "$output" contains "Stopwatch started"
}

# Stop tests

@test 'stop: clears running timer' {
  _pomo_start_work
  _pomo_stop

  _pomo_read_state
  assert "$POMO_STATUS" equals "stopped"
}

@test 'stop: returns error when no timer running' {
  run _pomo_stop
  assert $state equals 1
  assert "$output" contains "No timer running"
}

@test 'stop: outputs elapsed time' {
  _pomo_start_work
  pomo_mock_time 1000060  # 60 seconds later

  run _pomo_stop
  assert "$output" contains "Stopped after"
  assert "$output" contains "01:00"
}

# Pause tests

@test 'pause: changes status to paused' {
  _pomo_start_work
  _pomo_pause

  _pomo_read_state
  assert "$POMO_STATUS" equals "paused"
}

@test 'pause: records elapsed time' {
  _pomo_start_work
  pomo_mock_time 1000060  # 60 seconds later
  _pomo_pause

  _pomo_read_state
  assert "$POMO_PAUSE_ELAPSED" equals "60"
}

@test 'pause: returns error when no timer running' {
  run _pomo_pause
  assert $state equals 1
  assert "$output" contains "No timer running to pause"
}

@test 'pause: outputs paused time' {
  _pomo_start_work
  pomo_mock_time 1000300  # 5 minutes later

  run _pomo_pause
  assert "$output" contains "Timer paused at"
  assert "$output" contains "05:00"
}

# Resume tests

@test 'resume: changes status to running' {
  _pomo_start_work
  pomo_mock_time 1000060
  _pomo_pause
  pomo_mock_time 1000120
  _pomo_resume

  _pomo_read_state
  assert "$POMO_STATUS" equals "running"
}

@test 'resume: updates start time' {
  _pomo_start_work
  pomo_mock_time 1000060
  _pomo_pause
  pomo_mock_time 1000120
  _pomo_resume

  _pomo_read_state
  assert "$POMO_START_TIME" equals "1000120"
}

@test 'resume: returns error when not paused' {
  run _pomo_resume
  assert $state equals 1
  assert "$output" contains "No timer paused to resume"
}

@test 'resume: returns error when running' {
  _pomo_start_work
  run _pomo_resume
  assert $state equals 1
}

# Start flowtime tests

@test 'start_flowtime: sets mode to flowtime' {
  _pomo_start_flowtime

  _pomo_read_state
  assert "$POMO_MODE" equals "flowtime"
}

@test 'start_flowtime: sets status to running' {
  _pomo_start_flowtime

  _pomo_read_state
  assert "$POMO_STATUS" equals "running"
}

@test 'start_flowtime: no target sets duration to 0' {
  _pomo_start_flowtime

  _pomo_read_state
  assert "$POMO_DURATION" equals "0"
}

@test 'start_flowtime: with target sets duration correctly' {
  _pomo_start_flowtime "2700"  # 45 minutes

  _pomo_read_state
  assert "$POMO_DURATION" equals "2700"
}

@test 'start_flowtime: initializes target_notified to 0' {
  _pomo_start_flowtime "600"

  _pomo_read_state
  assert "$POMO_TARGET_NOTIFIED" equals "0"
}

@test 'start_flowtime: outputs open-ended message when no target' {
  run _pomo_start_flowtime
  assert "$output" contains "Flowtime started"
  assert "$output" contains "open-ended"
}

@test 'start_flowtime: outputs target message when target specified' {
  run _pomo_start_flowtime "2700"
  assert "$output" contains "Flowtime started"
  assert "$output" contains "soft target"
  assert "$output" contains "45:00"
}

@test 'flowtime: is_completed always returns false' {
  _pomo_start_flowtime "60"  # 1 minute target
  pomo_mock_time 1000120  # 2 minutes later (past target)

  run _pomo_is_completed
  assert $state equals 1  # Should return false (1)
}

@test 'flowtime: status shows elapsed time' {
  _pomo_start_flowtime
  pomo_mock_time 1000120  # 2 minutes later

  run _pomo_status
  assert "$output" contains "Flowtime"
  assert "$output" contains "Elapsed"
  assert "$output" contains "02:00"
}

@test 'flowtime: status shows soft target when set' {
  _pomo_start_flowtime "2700"

  run _pomo_status
  assert "$output" contains "Soft target"
  assert "$output" contains "45:00"
}

@test 'flowtime: status shows target reached message' {
  _pomo_start_flowtime "60"  # 1 minute target
  pomo_mock_time 1000120  # 2 minutes later

  run _pomo_status
  assert "$output" contains "Target reached"
}
